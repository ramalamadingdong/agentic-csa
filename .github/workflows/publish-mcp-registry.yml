name: Publish to MCP Registry

on:
  workflow_run:
    workflows: ["Publish to PyPI"]
    types:
      - completed
  workflow_dispatch:

jobs:
  publish-mcp-registry:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch || github.ref }}

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Update server.json version
        run: |
          VERSION=$(grep -oP 'version = "\K[^"]+' pyproject.toml)
          jq --arg v "$VERSION" '.version = $v | .packages[0].version = $v' server.json > tmp.json
          mv tmp.json server.json
          echo "Version: $VERSION"

      - name: Publish to MCP Registry
        env:
          GITHUB_TOKEN: ${{ secrets.MCP_REGISTRY_TOKEN }}
        run: |
          npx --yes @modelcontextprotocol/publisher validate server.json
          npx --yes @modelcontextprotocol/publisher publish server.json
